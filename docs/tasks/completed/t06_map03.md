# t06_map03: Frontend Local Database Schema Alignment & UI Data Consistency

## Status: COMPLETED

## Summary
Restructured all frontend TypeScript types, mock data, and UI components to align with the finalized backend DynamoDB and RDB schemas. This ensures zero-friction integration when connecting to the real backend API.

## Changes Made

### Types (packages/shared/src/index.ts)
- Added: `SurfInfo`, `SurfInfoGeo`, `SurfInfoConditions`, `SurfInfoDerivedMetrics`, `SurfInfoMetadata`, `SurfGrade`, `SurfingLevel`, `SavedListItem`, `FeedbackRDB`
- Removed: `SurfSpot`, `SurfConditions`, `SurfForecast`, `ForecastTimeSlot`, `SpotForecastData`, `LocationForecast`, `SavedSpotMarker`, `SavedSpot`, `WeatherOverlayData`, `MeasureDistancePoint`, `WindParticle`

### New Service Files
- `apps/web/lib/services/surfInfoService.ts` — Forecast generation with seeded random, grade/level/score calculation
- `apps/web/lib/services/savedListService.ts` — localStorage-based saved list CRUD with duplicate prevention
- `apps/web/lib/services/userService.ts` — Mock user authentication wrapper

### Data Layer (apps/web/lib/data.ts)
- Rewrote 50 mock surf spots as `SurfInfo` with nested `geo`, `conditions`, `derivedMetrics`, `metadata`
- LocationId format: `{lat}#{lng}`
- `searchSpotsWithFilters()` and `getNearbySpots()` return enriched `SearchResult` (SurfInfo + distance)

### Updated Components
- **SpotDetailPanel.tsx** — Props: `surfInfo: SurfInfo`, score 0-100 scale, grade badge (A/B/C/D), 4 condition fields only
- **SearchResultsList.tsx** — Uses `derivedMetrics.surfScore`, grade badge, pagination reset on new results
- **EnhancedMapboxMap.tsx** — Props: `SurfInfo[]` + `SavedListItem[]`, optimized marker lifecycle (ref-based date), wavePeriod cached properly
- **SavedSpotCard.tsx** — Uses `SavedListItem` with flattened data display

### Updated Pages
- **map/page.tsx** — Integrated new services, auth guard preserved
- **saved/page.tsx** — Uses `savedListService` for CRUD

### Deleted Files
- `apps/web/lib/mockForecastData.ts`
- `apps/web/components/SurfDataPopup.tsx`
- `apps/web/components/ForecastPopup.tsx`
- `apps/web/components/SpotPopup.tsx`
- `apps/web/components/SpotCard.tsx`
- `apps/web/components/MapboxMap.tsx`
- `apps/web/components/InfoPanel.tsx`
- `apps/web/components/WindParticles.tsx`
- `apps/web/lib/openMeteoService.ts`
- `apps/web/app/map/page_old.tsx`

### Bug Fixes During Review
- Added `wavePeriod` to coordinate cache (was missing, causing stale data in detail panel)
- Added duplicate prevention to `addToSavedList`
- Added pagination reset on new search results in `SearchResultsList`
- Optimized marker re-creation: markers no longer flicker on date change (uses ref for selectedDate)

## Score System
- surfScore: 0-100 (was 1-5)
- surfGrade: A (>=80), B (>=60), C (>=40), D (<40)
- surfingLevel: BEGINNER, INTERMEDIATE, ADVANCED
- Conditions: waveHeight, wavePeriod, windSpeed, waterTemperature (4 fields only)

## Verification
- `pnpm --filter web build` passes with zero TypeScript errors
- All 50 spots render as markers on map
- Search returns results with surfScore + surfGrade
- Save/remove spots works with SavedListItem schema
- Auth guard still works
