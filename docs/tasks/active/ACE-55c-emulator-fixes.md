# ACE-55c: Emulator Testing Fixes — Icon, Splash, Localhost, System UI

## Status: COMPLETED ✅
## Date: 2026-02-22
## Branch: feature/ACE-55

---

## Issues Fixed

| # | Issue | Root Cause | Fix Applied |
|---|-------|-----------|-------------|
| 1 | App icon shows default Android robot | Old Capacitor default XML vector files in `drawable/` conflicting + stale APK cache on emulator | Deleted old XMLs; requires clean APK rebuild + app uninstall on emulator |
| 2 | Splash screen not showing awaves logo | Android 15 uses Window Splash Screen API (API 31+); `android:background` in `styles.xml` is ignored | Created `values-v31/styles.xml` with `windowSplashScreenBackground` + `windowSplashScreenAnimatedIcon` |
| 3 | Can't test browser + emulator at same URL | Config used `10.0.2.2` (emulator-only alias) | Switched to `adb reverse` approach — both browser and emulator now use `http://localhost` |
| 4 | System UI unresponsive in AVD | Default AVD uses software rendering + low RAM | AVD settings: Hardware GLES 2.0 + 4096MB RAM (see below) |

---

## Files Changed

| File | Action |
|------|--------|
| `apps/web/android/app/src/main/res/drawable/ic_launcher_background.xml` | **Deleted** — old teal `#26A69A` vector (Capacitor default) |
| `apps/web/android/app/src/main/res/drawable-v24/ic_launcher_foreground.xml` | **Deleted** — old Android robot vector (Capacitor default) |
| `apps/web/android/app/src/main/res/values-v31/styles.xml` | **Created** — Android 12+ splash screen override |
| `apps/web/android/app/src/main/res/xml/network_security_config.xml` | **Updated** — simplified; localhost exempt by default |
| `apps/web/capacitor.config.ts` | **Updated** — server.url from `10.0.2.2:3000` → `localhost:3000` |
| `apps/web/.env.local` | **Updated** — `NEXT_PUBLIC_API_URL` from `10.0.2.2:8001` → `localhost:8001` |
| `apps/web/next.config.js` | **Updated** — removed `allowedDevOrigins` (no longer needed with adb reverse) |
| `apps/api/.env.local` | **Updated** — removed `10.0.2.2:3000` from `CORS_ORIGINS` |

---

## Fix Details

### Fix 1 — Icon (stale cache)

The PNG assets were correctly generated by `@capacitor/assets` (verified pixel data):
- `mipmap-xxhdpi/ic_launcher_background.png` center pixel: `#094074` (ocean blue ✅)
- `mipmap-xxhdpi/ic_launcher_foreground.png` center pixel: `#F08F2B` (awaves orange ✅)

The icon not appearing was caused by:
1. Old default Capacitor XML vector files (`drawable/ic_launcher_background.xml` = teal `#26A69A` grid, `drawable-v24/ic_launcher_foreground.xml` = Android robot) — now **deleted**.
2. Stale APK cache — the old APK was installed on the emulator. Android caches launcher icons aggressively.

**Required after these fixes:** Uninstall the old app from the emulator, then do a clean build + reinstall.

---

### Fix 2 — Splash Screen (Android 12+ Window Splash Screen API)

**What was wrong:** `styles.xml` had:
```xml
<style name="AppTheme.NoActionBarLaunch" parent="Theme.SplashScreen">
    <item name="android:background">@drawable/splash</item>
</style>
```

On Android 12+ (API 31+, including Android 15), the `Theme.SplashScreen` uses the Window Splash Screen API. The `android:background` attribute maps to `windowBackground` (pre-Android 12 window backdrop), which is **not** the splash screen background on modern Android. The result: white background with the app icon in a circle.

**What was created:** `res/values-v31/styles.xml` overrides the style for API 31+:
```xml
<style name="AppTheme.NoActionBarLaunch" parent="Theme.SplashScreen">
    <item name="windowSplashScreenBackground">@color/colorPrimary</item>  <!-- #094074 -->
    <item name="windowSplashScreenAnimatedIcon">@mipmap/ic_launcher_foreground</item>
    <item name="windowSplashScreenIconBackgroundColor">@color/colorPrimary</item>
    <item name="postSplashScreenTheme">@style/AppTheme.NoActionBar</item>
</style>
```

**What Android 12+ splash now shows:**
- Ocean blue background (`#094074`)
- Awaves wave logo (orange `#F08F2B`) in the centre
- Seamless transition to the app

On Android 11 and below, the existing `styles.xml` with `@drawable/splash` continues to be used (full-screen splash PNG).

---

### Fix 3 — Unified localhost (adb reverse)

**What changed:** Removed all `10.0.2.2` references. Both browser dev and emulator now use `http://localhost`.

**How it works:** `adb reverse` creates a TCP forwarding rule inside the running emulator:
```
adb reverse tcp:PORT tcp:PORT
```
This makes `localhost:PORT` inside the emulator point to the host machine's `localhost:PORT`.

**Why localhost is safe for Android cleartext:** Loopback addresses (`localhost`, `127.0.0.1`) are permanently exempt from Android cleartext traffic restrictions (all API levels). No `network_security_config.xml` domain rule is needed.

**Config after fix:**
| File | Setting |
|------|---------|
| `apps/web/.env.local` | `NEXT_PUBLIC_API_URL=http://localhost:8001` |
| `apps/web/capacitor.config.ts` | `url: 'http://localhost:3000'` |
| `apps/api/.env.local` | `CORS_ORIGINS=http://localhost:3000,http://127.0.0.1:3000` |

---

## Testing Procedure

### Every Emulator Test Session

**One-time terminal setup (run first, once per AVD session):**
```bash
# Start the emulator in Android Studio first, then:
adb reverse tcp:3000 tcp:3000
adb reverse tcp:8001 tcp:8001
# Verify:
adb reverse --list
# Expected output:
# (reverse) tcp:3000 tcp:3000
# (reverse) tcp:8001 tcp:8001
```

**Terminal 1 — Backend:**
```bash
cd apps/api
.venv/Scripts/python -m uvicorn app.main:app --reload --port 8001
# NOTE: --host 0.0.0.0 is no longer required (adb reverse handles routing)
```

**Terminal 2 — Frontend:**
```bash
cd apps/web
pnpm dev
# NOTE: --hostname 0.0.0.0 is no longer required
```

**Terminal 3 — Rebuild and open Android Studio:**
```bash
cd apps/web
node_modules/.bin/cap sync android
```
Then in Android Studio:
1. **Uninstall old app** from emulator first (long-press icon → Uninstall, or `adb uninstall com.awaves.net`)
2. **Build → Clean Project**
3. **Build → Build Bundle(s)/APK(s) → Build APK(s)**
4. **Run ▶**

### Browser Dev (no changes needed)

```bash
# Terminal 1
cd apps/api
.venv/Scripts/python -m uvicorn app.main:app --reload --port 8001

# Terminal 2
cd apps/web
pnpm dev
```
Open: `http://localhost:3000` — no config changes required. Same URLs as emulator now.

---

### AVD Settings — Fix System UI Unresponsive

The "System UI is unresponsive" error on Android Studio emulator is caused by:
1. **Software rendering** — the default AVD uses software GLES (CPU-only), which is extremely slow for WebGL + Mapbox
2. **Low RAM** — default AVD has 2048MB which is insufficient for Android 15 + a WebView

**One-time fix (Android Studio):**

1. **Device Manager** → click ✏️ next to your AVD
2. **Show Advanced Settings**
3. Set **Graphics** → `Hardware - GLES 2.0`
4. Set **RAM** → `4096 MB`
5. Set **VM Heap** → `512 MB`
6. Set **Internal Storage** → `4096 MB`
7. Click **Finish**
8. **Cold Boot** the AVD (Device Manager → ▼ → Cold Boot Now)

After Cold Boot: run `adb reverse` again (it resets on each boot).

**Why Cold Boot?** A Cold Boot forces Android to restart the System UI from scratch, clearing any stuck state from the previous session.

---

### Checklist

**App Icon:**
- [ ] Uninstalled old app from emulator
- [ ] Clean build done (Build → Clean Project → Build APK)
- [ ] Launcher shows ocean blue background with orange wave logo

**Splash Screen:**
- [ ] App launch shows ocean blue (`#094074`) background
- [ ] Awaves wave logo visible in centre during 2s splash
- [ ] Smooth transition into login page

**Browser + Emulator unified:**
- [ ] `adb reverse` ran before emulator test
- [ ] Browser at `http://localhost:3000` — login works ✅
- [ ] Emulator at `http://localhost:3000` (via adb reverse) — login works ✅
- [ ] No manual `.env.local` switching between modes

**System UI:**
- [ ] AVD set to Hardware - GLES 2.0
- [ ] AVD RAM set to 4096 MB
- [ ] No "System UI is unresponsive" dialog after Cold Boot

---

## Config Quick Reference

| Scenario | `NEXT_PUBLIC_API_URL` | `capacitor.config.ts server.url` | Backend | Extra step |
|----------|----------------------|----------------------------------|---------|------------|
| **Browser dev** | `http://localhost:8001` ✅ | *(irrelevant)* | `uvicorn ... --port 8001` | none |
| **Android emulator** | `http://localhost:8001` ✅ | `http://localhost:3000` ✅ | `uvicorn ... --port 8001` | `adb reverse tcp:3000 tcp:3000 && adb reverse tcp:8001 tcp:8001` |
| **Physical device (WiFi)** | `http://192.168.x.x:8001` | `http://192.168.x.x:3000` | `uvicorn --host 0.0.0.0 --port 8001` | Add IP to `network_security_config.xml` + `.env.local` |
| **Production EKS** | baked via Docker build-arg | `https://mobile.awaves.net` | EKS pod | — |

---

## Known Limitations (not bugs)

| Item | Notes |
|------|-------|
| `adb reverse` resets on AVD Cold Boot | Run `adb reverse` again after each Cold Boot |
| `pnpm build` EPERM symlink (Windows) | `output: 'standalone'` requires symlinks. Use Docker (Linux) for production builds. |
| Android 12+ splash is a small centred icon | New platform behaviour — full-screen splash not supported without a custom SplashScreen Activity |
| Mapbox needs GPU | AVD must use Hardware GLES 2.0; software emulation = blank map |
